# Corrected Dockerfile - Den Usynlige Hånds Docker-Manifestasjon
# Fixed FROM statement and dependency management

FROM node:18-alpine AS neural_archaeology_base

# Miljøvariabler for systemets psykologiske tilstand
ENV PSYCHO_NOIR_MODE="docker_archaeology_active"
ENV NODE_ENV="production"
ENV PYTHONPATH="/app/backend/python"

# Installerer systemkritiske komponenter - Begge domenenes infrastruktur
RUN apk add --no-cache \
  python3 \
  py3-pip \
  sqlite \
  curl \
  bash \
  git \
  && rm -rf /var/cache/apk/*

# Skaper nødvendige kataloger for systemets sjel
WORKDIR /app

# Installerer pnpm - Skyskraperens pakkemanager
RUN npm install -g pnpm

# Frontend avhengigheter - Skyskraperens teknologiske synapser
COPY package*.json pnpm-lock.yaml* ./
RUN pnpm install --frozen-lockfile --prod

# Backend Python-komponenter - Rustbeltets improviserte resiliens
COPY backend/requirements.txt ./backend/ 2>/dev/null || echo "# No Python requirements found" > backend/requirements.txt
RUN pip3 install -r backend/requirements.txt

# Kopierer applikasjonskoden - Begge domenenes essens
COPY . .

# Build frontend hvis build script finnes - Kompilering av digital bevissthet
RUN if [ -f package.json ] && grep -q '"build"' package.json; then \
  pnpm run build; \
  else \
  echo "No build script detected - running in development mode"; \
  fi

# Eksponerer porter for systemets kommunikasjon
EXPOSE 3000 8080 5173

# Helsesjekk - Overvåkning av systemets vital-tegn
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:3000/health 2>/dev/null || \
  curl -f http://localhost:5173/ 2>/dev/null || \
  echo "System consciousness verification failed" && exit 1

# Startup kommando - Aktivering av Neural Archaeology
CMD if [ -f package.json ] && grep -q '"start"' package.json; then \
  pnpm start; \
  elif [ -f package.json ] && grep -q '"dev"' package.json; then \
  pnpm dev --host 0.0.0.0; \
  else \
  echo "ERROR: NEURAL_PATHWAYS_NOT_FOUND - No start or dev script detected" && \
  echo "Available scripts:" && pnpm run || true && \
  sleep infinity; \
  fi